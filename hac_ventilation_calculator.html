<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAC & Ventilation Calculator - Professional Edition</title>
    <style>
        /* Стили остаются без изменений */
        :root {
            --ink: #e5e7eb;
            --muted: #94a3b8;
            --brand: #22d3ee;
            --accent: #34d399;
            --code: #0b132b;
            --background: #0b1021;
            --card-bg: rgba(255, 255, 255, 0.06);
            --card-border: rgba(255, 255, 255, 0.12);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu;
            background: var(--background);
            color: var(--ink);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .wrap {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            position: relative;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            font-size: 2.2rem;
            margin: 0.2rem 0;
            background: linear-gradient(135deg, var(--brand), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
        }

        .lang {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 8px;
        }

        .lang button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .lang button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .lang button.active {
            background: #fff;
            color: #1a6fb0;
        }

        .download-btn {
            position: absolute;
            top: 0;
            right: 120px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin: 16px 0;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 20px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.06);
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab.active {
            border-color: var(--brand);
            color: var(--brand);
            background: rgba(255, 255, 255, 0.12);
        }

        .content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .content.active {
            display: block;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            margin-top: 0;
            color: var(--brand);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
        }

        .subgrid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .input {
            display: grid;
            grid-template-columns: 1.4fr 1fr 0.8fr;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }

        .input label {
            color: var(--muted);
            font-size: 0.92rem;
        }

        .input input, .input select {
            width: 100%;
            padding: 10px;
            border: 1px solid #1f2937;
            border-radius: 8px;
            background: var(--code);
            color: var(--ink);
            transition: all 0.3s ease;
        }

        .input input:focus, .input select:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.2);
        }

        .u {
            font-size: 0.8rem;
            color: var(--muted);
            text-align: right;
        }

        .hint {
            font-size: 0.85rem;
            color: var(--muted);
            margin: 6px 0;
            font-style: italic;
        }

        .btn {
            cursor: pointer;
            background: linear-gradient(135deg, var(--brand), var(--accent));
            color: #001;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 700;
            margin-top: 10px;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .results {
            background: var(--code);
            border: 1px dashed #334155;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .row:last-child {
            border-bottom: none;
        }

        .val {
            color: var(--accent);
            font-weight: 700;
        }

        .small {
            display: block;
            font-size: 0.8rem;
            color: #9aa2b1;
            margin-top: 2px;
        }

        .summary {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .pill {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 14px;
            border: 1px solid #334155;
            margin-left: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .ok {
            border-color: #10b981;
            color: #a7f3d0;
            background: rgba(16, 185, 129, 0.15);
        }

        .warn {
            border-color: #f59e0b;
            color: #fde68a;
            background: rgba(245, 158, 11, 0.12);
        }

        .bad {
            border-color: #ef4444;
            color: #fecaca;
            background: rgba(239, 68, 68, 0.12);
        }

        .need {
            color: #fca5a5;
            font-weight: 700;
        }

        .tip {
            background: #0b132b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            color: #a7b3c3;
        }

        canvas {
            background: #0b132b;
            border: 1px solid #334155;
            border-radius: 8px;
            margin-top: 10px;
        }

        .section-title {
            font-size: 1.2rem;
            color: var(--brand);
            margin: 20px 0 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .calculation-steps {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid var(--brand);
        }

        .formula {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 6px;
            margin: 10px 0;
            display: inline-block;
        }

        .final-classification {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--brand);
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .input {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .lang {
                position: relative;
                margin-top: 10px;
            }
            
            .download-btn {
                position: relative;
                right: 0;
                margin-top: 10px;
            }
        }
        
        .auto-value {
            color: var(--brand);
            font-weight: 600;
        }
        
        .flow-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            border-left: 4px solid var(--accent);
        }
        
        .flow-info.choked {
            border-left-color: #f59e0b;
        }
        
        .flow-info.subsonic {
            border-left-color: #10b981;
        }
    </style>
</head>
<body>
    <div class="wrap">
        <header>
            <h1 id="t_title">HAC & Ventilation Calculator</h1>
            <p class="hint" id="t_sub">Professional calculator for hazardous area classification and ventilation analysis according to I.S. EN IEC 60079-10-1</p>
            
            <div class="lang">
                <button id="btnEN" class="active">EN</button>
                <button id="btnUA">UA</button>
            </div>
            
            <button class="download-btn" id="downloadBtn">Download Calculator</button>
        </header>

        <div class="tabs">
            <div class="tab active" data-id="outdoor">Outdoor Scenario</div>
            <div class="tab" data-id="enclosed">Enclosed Scenario</div>
            <div class="tab" data-id="help">Instructions</div>
        </div>

        <!-- Outdoor Scenario -->
        <div class="content active" id="outdoor">
            <!-- Содержимое Outdoor Scenario без изменений -->
            <div class="card">
                <h3>Gas Properties</h3>
                <div class="input">
                    <label for="out_M">Molar Mass M (g/mol)</label>
                    <input type="number" id="out_M" step="any" value="44.097">
                    <span class="u">g/mol</span>
                </div>
                <div class="input">
                    <label for="out_gamma">Specific Heat Ratio γ</label>
                    <input type="number" id="out_gamma" step="any" value="1.13">
                    <span class="u">-</span>
                </div>
                <div class="input">
                    <label for="out_LFL">Lower Flammable Limit LFL</label>
                    <input type="number" id="out_LFL" step="any" value="0.017">
                    <span class="u">vol/vol</span>
                </div>
                <div class="input">
                    <label for="out_T">Temperature T</label>
                    <input type="number" id="out_T" step="any" value="293.15">
                    <span class="u">K</span>
                </div>
                <div class="input">
                    <label for="out_Pa">Atmospheric Pressure P<sub>a</sub></label>
                    <input type="number" id="out_Pa" step="any" value="101325">
                    <span class="u">Pa</span>
                </div>
                <div class="input">
                    <label for="out_R">Gas Constant R</label>
                    <input type="number" id="out_R" step="any" value="8314.5">
                    <span class="u">J/kmol·K</span>
                </div>
                <div class="input">
                    <label for="out_Z">Compressibility Factor Z</label>
                    <input type="number" id="out_Z" step="any" value="1.0">
                    <span class="u">-</span>
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <h3>Upstream Release (Before Regulator)</h3>
                    <div class="input">
                        <label for="out_S_upstream">Hole Area S</label>
                        <input type="number" id="out_S_upstream" step="any" value="0.25">
                        <span class="u">mm²</span>
                    </div>
                    <div class="input">
                        <label for="out_Cd_upstream">Discharge Coefficient C<sub>d</sub></label>
                        <input type="number" id="out_Cd_upstream" step="any" value="0.99">
                        <span class="u">-</span>
                    </div>
                    <div class="input">
                        <label for="out_p_upstream">Upstream Pressure P₀</label>
                        <input type="number" id="out_p_upstream" step="any" value="9.0">
                        <span class="u">bar abs</span>
                    </div>
                    <div class="input">
                        <label for="out_release_type_upstream">Release Type</label>
                        <select id="out_release_type_upstream">
                            <option value="primary">Primary</option>
                            <option value="secondary">Secondary</option>
                        </select>
                    </div>
                </div>

                <div class="card">
                    <h3>Downstream Release (After Regulator)</h3>
                    <div class="input">
                        <label for="out_S_downstream">Hole Area S</label>
                        <input type="number" id="out_S_downstream" step="any" value="0.25">
                        <span class="u">mm²</span>
                    </div>
                    <div class="input">
                        <label for="out_Cd_downstream">Discharge Coefficient C<sub>d</sub></label>
                        <input type="number" id="out_Cd_downstream" step="any" value="0.99">
                        <span class="u">-</span>
                    </div>
                    <div class="input">
                        <label for="out_p_downstream">Downstream Pressure P₀</label>
                        <input type="number" id="out_p_downstream" step="any" value="1.5">
                        <span class="u">bar abs</span>
                    </div>
                    <div class="input">
                        <label for="out_release_type_downstream">Release Type</label>
                        <select id="out_release_type_downstream">
                            <option value="primary">Primary</option>
                            <option value="secondary">Secondary</option>
                        </select>
                    </div>
                </div>
            </div>

            <button class="btn" id="btnOutdoor">Calculate Outdoor Scenario</button>

            <div class="results" id="resOutdoor">
                <p>Results will appear here after calculation...</p>
            </div>
        </div>

        <!-- Enclosed Scenario -->
        <div class="content" id="enclosed">
            <div class="card">
                <h3>Gas Properties</h3>
                <div class="input">
                    <label for="enc_M">Molar Mass M (g/mol)</label>
                    <input type="number" id="enc_M" step="any" value="44.097">
                    <span class="u">g/mol</span>
                </div>
                <div class="input">
                    <label for="enc_gamma">Specific Heat Ratio γ</label>
                    <input type="number" id="enc_gamma" step="any" value="1.13">
                    <span class="u">-</span>
                </div>
                <div class="input">
                    <label for="enc_LFL">Lower Flammable Limit LFL</label>
                    <input type="number" id="enc_LFL" step="any" value="0.017">
                    <span class="u">vol/vol</span>
                </div>
                <div class="input">
                    <label for="enc_T">Temperature T</label>
                    <input type="number" id="enc_T" step="any" value="293.15">
                    <span class="u">K</span>
                </div>
                <div class="input">
                    <label for="enc_Pa">Atmospheric Pressure P<sub>a</sub></label>
                    <input type="number" id="enc_Pa" step="any" value="101325">
                    <span class="u">Pa</span>
                </div>
                <div class="input">
                    <label for="enc_R">Gas Constant R</label>
                    <input type="number" id="enc_R" step="any" value="8314.5">
                    <span class="u">J/kmol·K</span>
                </div>
                <div class="input">
                    <label for="enc_Z">Compressibility Factor Z</label>
                    <input type="number" id="enc_Z" step="any" value="1.0">
                    <span class="u">-</span>
                </div>
            </div>

            <div class="card">
                <h3>Release Parameters</h3>
                <div class="input">
                    <label for="enc_S">Hole Area S</label>
                    <input type="number" id="enc_S" step="any" value="0.25">
                    <span class="u">mm²</span>
                </div>
                <div class="input">
                    <label for="enc_Cd">Discharge Coefficient C<sub>d</sub></label>
                    <input type="number" id="enc_Cd" step="any" value="0.99">
                    <span class="u">-</span>
                </div>
                <div class="input">
                    <label for="enc_p">Upstream Pressure P₀</label>
                    <input type="number" id="enc_p" step="any" value="1.5">
                    <span class="u">bar abs</span>
                </div>
                <div class="input">
                    <label for="enc_release_type">Release Type</label>
                    <select id="enc_release_type">
                        <option value="primary">Primary</option>
                        <option value="secondary" selected>Secondary</option>
                    </select>
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <h3>Room Parameters</h3>
                    <div class="input">
                        <label for="enc_length">Length L</label>
                        <input type="number" id="enc_length" step="any" value="2.0">
                        <span class="u">m</span>
                    </div>
                    <div class="input">
                        <label for="enc_width">Width W</label>
                        <input type="number" id="enc_width" step="any" value="1.5">
                        <span class="u">m</span>
                    </div>
                    <div class="input">
                        <label for="enc_height">Height H</label>
                        <input type="number" id="enc_height" step="any" value="2.2">
                        <span class="u">m</span>
                    </div>
                    <div class="input">
                        <label for="enc_volume">Volume V₀</label>
                        <input type="number" id="enc_volume" step="any" value="6.6" readonly>
                        <span class="u">m³</span>
                    </div>
                </div>

                <div class="card">
                    <h3>Ventilation Parameters</h3>
                    <div class="input">
                        <label for="enc_A1">Upwind Opening Area A₁</label>
                        <input type="number" id="enc_A1" step="any" value="0.02">
                        <span class="u">m²</span>
                    </div>
                    <div class="input">
                        <label for="enc_A2">Downwind Opening Area A₂</label>
                        <input type="number" id="enc_A2" step="any" value="0.02">
                        <span class="u">m²</span>
                    </div>
                    <div class="input">
                        <label for="enc_Cd_vent">Ventilation C<sub>d</sub></label>
                        <input type="number" id="enc_Cd_vent" step="any" value="0.75">
                        <span class="u">-</span>
                    </div>
                    <div class="input">
                        <label for="enc_deltaCp">Pressure Coeff. ΔC<sub>p</sub></label>
                        <input type="number" id="enc_deltaCp" step="any" value="0.25">
                        <span class="u">-</span>
                    </div>
                    <div class="input">
                        <label for="enc_wind_speed">Wind Speed u<sub>w</sub></label>
                        <input type="number" id="enc_wind_speed" step="any" value="1.0">
                        <span class="u">m/s</span>
                    </div>
                    <div class="input">
                        <label for="enc_f">Ventilation Inefficiency f</label>
                        <input type="number" id="enc_f" step="any" value="2.0">
                        <span class="u">-</span>
                    </div>
                </div>
            </div>

            <button class="btn" id="btnEnclosed">Calculate Enclosed Scenario</button>

            <div class="results" id="resEnclosed">
                <p>Results will appear here after calculation...</p>
            </div>
        </div>

        <!-- Instructions -->
        <div class="content" id="help">
            <div class="card">
                <h3 id="ins_title">Instructions</h3>
                <div id="ins_content">
                    <p>This professional calculator assists in hazardous area classification and ventilation analysis according to I.S. EN IEC 60079-10-1 and related standards.</p>
                    
                    <div class="section-title">Calculation Methodology</div>
                    <p>The calculator uses corrected formulas based on I.S. EN IEC 60079-10-1:</p>
                    
                    <div class="calculation-steps">
                        <p><strong>Corrected calculations:</strong></p>
                        <ol>
                            <li><strong>Critical pressure</strong>: P<sub>crit</sub> = P<sub>a</sub> × [(γ+1)/2]<sup>γ/(γ-1)</sup></li>
                            <li><strong>Choked flow mass rate</strong>: ṁ = C<sub>d</sub> × S × P₀ × √[γ/(R×T₀/M)] × [2/(γ+1)]<sup>(γ+1)/(2(γ-1))</sup></li>
                            <li><strong>Subsonic flow mass rate</strong>: ṁ = C<sub>d</sub> × S × P₀ × √[2γ/((γ-1)R×T₀/M) × ((P<sub>a</sub>/P₀)<sup>2/γ</sup> - (P<sub>a</sub>/P₀)<sup>(γ+1)/γ</sup>)]</li>
                            <li><strong>Gas density</strong>: ρ = (Pₐ × M) / (R × T)</li>
                            <li><strong>Volumetric flows</strong>: Q<sub>g</sub> = ṁ/ρ, Q<sub>c</sub> = ṁ/(ρ × LFL)</li>
                            <li><strong>Indoor ventilation velocity</strong>: u<sub>w</sub> = Q<sub>a</sub> / (L × H)</li>
                            <li><strong>Background concentration</strong>: X<sub>b</sub> = min[(f × Q<sub>g</sub>) / Q<sub>2</sub>, 1.0]</li>
                            <li><strong>Effective ventilation area</strong>: A<sub>e</sub> = √( (A₁² × A₂²) / (A₁² + A₂²) )</li>
                            <li><strong>Air flow rate</strong>: Q<sub>a</sub> = C<sub>d</sub> × A<sub>e</sub> × u<sub>w</sub> × √ΔC<sub>p</sub></li>
                        </ol>
                    </div>
                    
                    <div class="section-title">References</div>
                    <ul>
                        <li>I.S. EN IEC 60079-10-1:2021 - Explosive atmospheres – Classification of areas – Explosive gas atmospheres</li>
                        <li>I.S. 3216:2014 - Code of Practice for Bulk storage of liquefied petroleum gas (LPG)</li>
                        <li>I.S. EN 12186:2014 - Gas infrastructure – gas pressure regulating stations</li>
                        <li>IGEM/TD/13 Ed 3 - Pressure regulating and exceeding 7 bar pipeline installations</li>
                        <li>UKLPG CoP 1 pt 1 & pt 4 - Bulk LPG storage at fixed installations</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Internationalization
        const I18N = {
            EN: {
                title: 'HAC & Ventilation Calculator',
                sub: 'Professional calculator for hazardous area classification and ventilation analysis according to I.S. EN IEC 60079-10-1',
                tabs: ['Outdoor Scenario', 'Enclosed Scenario', 'Instructions'],
                btnCalc: 'Calculate',
                btnOutdoor: 'Calculate Outdoor Scenario',
                btnEnclosed: 'Calculate Enclosed Scenario',
                download: 'Download Calculator',
                insTitle: 'Instructions',
                insContent: `
                    <p>This professional calculator assists in hazardous area classification and ventilation analysis according to I.S. EN IEC 60079-10-1 and related standards.</p>
                    
                    <div class="section-title">Calculation Methodology</div>
                    <p>The calculator uses corrected formulas based on I.S. EN IEC 60079-10-1:</p>
                    
                    <div class="calculation-steps">
                        <p><strong>Corrected calculations:</strong></p>
                        <ol>
                            <li><strong>Critical pressure</strong>: P<sub>crit</sub> = P<sub>a</sub> × [(γ+1)/2]<sup>γ/(γ-1)</sup></li>
                            <li><strong>Choked flow mass rate</strong>: ṁ = C<sub>d</sub> × S × P₀ × √[γ/(R×T₀/M)] × [2/(γ+1)]<sup>(γ+1)/(2(γ-1))</sup></li>
                            <li><strong>Subsonic flow mass rate</strong>: ṁ = C<sub>d</sub> × S × P₀ × √[2γ/((γ-1)R×T₀/M) × ((P<sub>a</sub>/P₀)<sup>2/γ</sup> - (P<sub>a</sub>/P₀)<sup>(γ+1)/γ</sup>)]</li>
                            <li><strong>Gas density</strong>: ρ = (Pₐ × M) / (R × T)</li>
                            <li><strong>Volumetric flows</strong>: Q<sub>g</sub> = ṁ/ρ, Q<sub>c</sub> = ṁ/(ρ × LFL)</li>
                            <li><strong>Indoor ventilation velocity</strong>: u<sub>w</sub> = Q<sub>a</sub> / (L × H)</li>
                            <li><strong>Background concentration</strong>: X<sub>b</sub> = min[(f × Q<sub>g</sub>) / Q<sub>2</sub>, 1.0]</li>
                            <li><strong>Effective ventilation area</strong>: A<sub>e</sub> = √( (A₁² × A₂²) / (A₁² + A₂²) )</li>
                            <li><strong>Air flow rate</strong>: Q<sub>a</sub> = C<sub>d</sub> × A<sub>e</sub> × u<sub>w</sub> × √ΔC<sub>p</sub></li>
                        </ol>
                    </div>
                    
                    <div class="section-title">References</div>
                    <ul>
                        <li>I.S. EN IEC 60079-10-1:2021 - Explosive atmospheres – Classification of areas – Explosive gas atmospheres</li>
                        <li>I.S. 3216:2014 - Code of Practice for Bulk storage of liquefied petroleum gas (LPG)</li>
                        <li>I.S. EN 12186:2014 - Gas infrastructure – gas pressure regulating stations</li>
                        <li>IGEM/TD/13 Ed 3 - Pressure regulating and exceeding 7 bar pipeline installations</li>
                        <li>UKLPG CoP 1 pt 1 & pt 4 - Bulk LPG storage at fixed installations</li>
                    </ul>
                `
            },
            
            UA: {
                title: 'Калькулятор HAC та вентиляції',
                sub: 'Професійний калькулятор для класифікації небезпечних зон та аналізу вентиляції згідно I.S. EN IEC 60079-10-1',
                tabs: ['Сценарій на відкритому повітрі', 'Сценарій у приміщенні', 'Інструкція'],
                btnCalc: 'Розрахувати',
                btnOutdoor: 'Розрахувати сценарій на відкритому повітрі',
                btnEnclosed: 'Розрахувати сценарій у приміщенні',
                download: 'Завантажити калькулятор',
                insTitle: 'Інструкція',
                insContent: `
                    <p>Цей професійний калькулятор допомагає у класифікації небезпечних зон та аналізі вентиляції згідно I.S. EN IEC 60079-10-1 та пов'язаних стандартів.</p>
                    
                    <div class="section-title">Методологія розрахунків</div>
                    <p>Калькулятор використовує виправлені формули на основі I.S. EN IEC 60079-10-1:</p>
                    
                    <div class="calculation-steps">
                        <p><strong>Виправлені розрахунки:</strong></p>
                        <ol>
                            <li><strong>Критичний тиск</strong>: P<sub>crit</sub> = P<sub>a</sub> × [(γ+1)/2]<sup>γ/(γ-1)</sup></li>
                            <li><strong>Масовий потік при звуковому потоці</strong>: ṁ = C<sub>d</sub> × S × P₀ × √[γ/(R×T₀/M)] × [2/(γ+1)]<sup>(γ+1)/(2(γ-1))</sup></li>
                            <li><strong>Масовий потік при дозвуковому потоці</strong>: ṁ = C<sub>d</sub> × S × P₀ × √[2γ/((γ-1)R×T₀/M) × ((P<sub>a</sub>/P₀)<sup>2/γ</sup> - (P<sub>a</sub>/P₀)<sup>(γ+1)/γ</sup>)]</li>
                            <li><strong>Щільність газу</strong>: ρ = (Pₐ × M) / (R × T)</li>
                            <li><strong>Об'ємні потоки</strong>: Q<sub>g</sub> = ṁ/ρ, Q<sub>c</sub> = ṁ/(ρ × LFL)</li>
                            <li><strong>Швидкість вентиляції у приміщенні</strong>: u<sub>w</sub> = Q<sub>a</sub> / (L × H)</li>
                            <li><strong>Фонова концентрація</strong>: X<sub>b</sub> = min[(f × Q<sub>g</sub>) / Q<sub>2</sub>, 1.0]</li>
                            <li><strong>Ефективна площа вентиляції</strong>: A<sub>e</sub> = √( (A₁² × A₂²) / (A₁² + A₂²) )</li>
                            <li><strong>Витрата повітря</strong>: Q<sub>a</sub> = C<sub>d</sub> × A<sub>e</sub> × u<sub>w</sub> × √ΔC<sub>p</sub></li>
                        </ol>
                    </div>
                    
                    <div class="section-title">Посилання</div>
                    <ul>
                        <li>I.S. EN IEC 60079-10-1:2021 - Вибухонебезпечні атмосфери – Класифікація зон – Вибухонебезпечні газові атмосфери</li>
                        <li>I.S. 3216:2014 - Правила експлуатації для зберігання зрідженого нафтового газу (LPG)</li>
                        <li>I.S. EN 12186:2014 - Газова інфраструктура – станції регулювання тиску газу</li>
                        <li>IGEM/TD/13 Ed 3 - Установки регулювання тиску та трубопроводи з тиском понад 7 бар</li>
                        <li>UKLPG CoP 1 pt 1 & pt 4 - Зберігання LPG на стаціонарних установках</li>
                    </ul>
                `
            }
        };

        let currentLang = 'EN';

        // Set language function
        function setLang(lang) {
            currentLang = lang;
            const L = I18N[lang];
            
            // Update main texts
            document.getElementById('t_title').textContent = L.title;
            document.getElementById('t_sub').textContent = L.sub;
            document.getElementById('downloadBtn').textContent = L.download;
            
            // Update tabs
            const tabs = [
                document.querySelector('[data-id="outdoor"]'),
                document.querySelector('[data-id="enclosed"]'),
                document.querySelector('[data-id="help"]')
            ];
            L.tabs.forEach((t, i) => tabs[i].textContent = t);
            
            // Update buttons
            document.getElementById('btnOutdoor').textContent = L.btnOutdoor;
            document.getElementById('btnEnclosed').textContent = L.btnEnclosed;
            
            // Update instructions
            document.getElementById('ins_title').textContent = L.insTitle;
            document.getElementById('ins_content').innerHTML = L.insContent;
            
            // Update language buttons
            document.getElementById('btnEN').classList.toggle('active', lang === 'EN');
            document.getElementById('btnUA').classList.toggle('active', lang === 'UA');
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                const id = this.dataset.id;
                document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            });
        });

        // Language switching
        document.getElementById('btnEN').addEventListener('click', () => setLang('EN'));
        document.getElementById('btnUA').addEventListener('click', () => setLang('UA'));

        // Download functionality
        document.getElementById('downloadBtn').addEventListener('click', function() {
            const element = document.documentElement.outerHTML;
            const blob = new Blob([element], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hac_ventilation_calculator.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Calculation functions
        function toNum(v) {
            return v == null ? null : parseFloat(String(v).trim().replace(',', '.'));
        }

        function fmt(x, d = 6) {
            if (x == null || isNaN(x)) return '---';
            if (x === 0) return '0';
            
            // For very small numbers, use exponential notation without 'e'
            if (Math.abs(x) < 0.0001) {
                const parts = x.toExponential(d).split('e');
                const coefficient = parseFloat(parts[0]).toFixed(d);
                const exponent = parseInt(parts[1]);
                return `${coefficient} × 10^${exponent}`;
            }
            
            // For normal numbers, use fixed notation
            let fixed = x.toFixed(d);
            // Remove trailing zeros and decimal point if needed
            fixed = fixed.replace(/\.?0+$/, '');
            if (fixed.endsWith('.')) fixed = fixed.slice(0, -1);
            return fixed;
        }

        function getLFL(id) {
            const raw = document.getElementById(id).value.trim().replace(',', '.');
            let v = parseFloat(raw);
            if (isNaN(v)) return null;
            if (v > 1) v = v / 100;
            document.getElementById(id).value = String(v);
            return v;
        }

        // ИСПРАВЛЕННАЯ ФУНКЦИЯ РАСЧЕТА КРИТИЧЕСКОГО ДАВЛЕНИЯ
        /**
         * Расчет критического давления по формуле из IEC 60079-10-1:2015
         * Правильная формула: Pc = Pa × [(γ+1)/2]^(γ/(γ-1))
         */
        function calculateCriticalPressure(Pa, gamma) {
            return Pa * Math.pow((gamma + 1) / 2, gamma / (gamma - 1));
        }

        /**
         * Расчет массового расхода для сверхзвукового потока
         * Формула: ṁ = C_d × S × P₀ × √[γ/(R×T₀/M)] × [2/(γ+1)]^((γ+1)/(2(γ-1)))
         */
        function calculateChokedMassFlow(Cd, S, P0, gamma, M, R, T) {
            const R_specific = R / M;  // Удельная газовая постоянная [J/(kg·K)]
            const critical_flow_factor = Math.pow(2/(gamma+1), (gamma+1)/(2*(gamma-1)));
            return Cd * S * P0 * Math.sqrt(gamma / (R_specific * T)) * critical_flow_factor;
        }

        /**
         * Расчет массового расхода для дозвукового потока
         * Формула: ṁ = C_d × S × P₀ × √[2γ/((γ-1)R×T₀/M) × ((P_a/P₀)^(2/γ) - (P_a/P₀)^((γ+1)/γ))]
         */
        function calculateSubsonicMassFlow(Cd, S, P0, Pa, gamma, M, R, T) {
            const R_specific = R / M;
            const pressure_ratio = Pa / P0;
            const term = Math.sqrt((2*gamma/((gamma-1)*R_specific*T)) * 
                          (Math.pow(pressure_ratio, 2/gamma) - Math.pow(pressure_ratio, (gamma+1)/gamma)));
            return Cd * S * P0 * term;
        }

        /**
         * Основная функция расчета массового расхода
         * Определяет тип потока и использует соответствующую формулу
         */
        function calculateMassReleaseRate(Cd, S, P0, Pa, gamma, M, R, T, Z) {
            const P_crit = calculateCriticalPressure(Pa, gamma);
            
            // Определение типа потока
            if (P0 > P_crit) {
                // Сверхзвуковой поток (P₀ > P_crit)
                return calculateChokedMassFlow(Cd, S, P0, gamma, M, R, T);
            } else {
                // Дозвуковой поток (P₀ <= P_crit)
                return calculateSubsonicMassFlow(Cd, S, P0, Pa, gamma, M, R, T);
            }
        }

        /**
         * Расчет плотности газа
         * Формула: ρ = (Pₐ × M) / (R × T)
         */
        function calculateGasDensity(Pa, M, R, T) {
            return (Pa * M) / (R * T);
        }

        /**
         * Расчет объемной характеристики выброса
         * Формула: Q_c = ṁ / (ρ_g × LFL)
         */
        function calculateVolumetricReleaseCharacteristic(mdot, rho_g, LFL) {
            return mdot / (rho_g * LFL);
        }

        // ИСПРАВЛЕННЫЕ ФУНКЦИИ ДЛЯ РАСЧЕТА ВЕНТИЛЯЦИИ

        /**
         * Расчет эффективной площади вентиляции
         * Формула: A_e = √( (A₁² × A₂²) / (A₁² + A₂²) )
         */
        function calculateEffectiveVentilationArea(A1, A2) {
            if (A1 === 0 || A2 === 0) return 0;
            return Math.sqrt((Math.pow(A1, 2) * Math.pow(A2, 2)) / (Math.pow(A1, 2) + Math.pow(A2, 2)));
        }

        /**
         * ПРАВИЛЬНЫЙ расчет расхода воздуха
         * Формула: Q_a = C_d × A_e × u_w × √ΔC_p
         */
        function calculateAirFlowRate(Cd, Ae, windSpeed, deltaCp) {
            return Cd * Ae * windSpeed * Math.sqrt(deltaCp);
        }

        /**
         * Расчет скорости вентиляции в помещении
         * Формула: u_w(indoor) = Q_a / (L × H)
         */
        function calculateVentilationVelocity(Qa, L, H) {
            if (L === 0 || H === 0) return 0;
            return Qa / (L * H);
        }

        /**
         * Расчет фоновой концентрации
         * Формула: X_b = min[(f × Q_g) / Q_2, 1.0]
         */
        function calculateBackgroundConcentration(f, Qg, Q2) {
            if (Q2 === 0) return 1.0;
            return Math.min((f * Qg) / Q2, 1.0);
        }

        /**
         * ПРАВИЛЬНЫЙ расчет частоты воздухообмена
         * Формула: C = Q_a / V_0
         */
        function calculateAirChangeRate(Qa, V0) {
            if (V0 === 0) return 0;
            return Qa / V0;
        }

        // Determine zone type according to Table D.1 (точное соответствие)
        function determineZoneType(releaseGrade, ventilationAvailability, dilutionLevel) {
            if (releaseGrade === 'continuous') {
                if (dilutionLevel === 'High' && ventilationAvailability === 'Good') return 'Zone 0 NE';
                if (dilutionLevel === 'High' && ventilationAvailability === 'Fair') return 'Zone 2 (Zone 0 NE)';
                if (dilutionLevel === 'High' && ventilationAvailability === 'Poor') return 'Zone 1 (Zone 0 NE)';
                if (dilutionLevel === 'Medium' && ventilationAvailability === 'Good') return 'Zone 0';
                return 'Zone 0';
            } else if (releaseGrade === 'primary') {
                if (dilutionLevel === 'High' && ventilationAvailability === 'Good') return 'Non-hazardous (Zone 1 NE)';
                if (dilutionLevel === 'High' && ventilationAvailability === 'Fair') return 'Zone 2 (Zone 1 NE)';
                if (dilutionLevel === 'High' && ventilationAvailability === 'Poor') return 'Zone 2 (Zone 1 NE)';
                if (dilutionLevel === 'Medium' && ventilationAvailability === 'Good') return 'Zone 1';
                if (dilutionLevel === 'Low') return 'Zone 1 or Zone 0';
                return 'Zone 1';
            } else if (releaseGrade === 'secondary') {
                if (dilutionLevel === 'High' && ventilationAvailability === 'Good') return 'Non-hazardous (Zone 2 NE)';
                if (dilutionLevel === 'High' && ventilationAvailability === 'Fair') return 'Non-hazardous (Zone 2 NE)';
                if (dilutionLevel === 'High' && ventilationAvailability === 'Poor') return 'Zone 2';
                if (dilutionLevel === 'Medium') return 'Zone 2';
                if (dilutionLevel === 'Low') return 'Zone 1 and even Zone 0';
                return 'Zone 2';
            }
            return 'Zone 2';
        }

        // CORRECTED Outdoor calculation
        document.getElementById('btnOutdoor').addEventListener('click', function() {
            // Get input values
            const M = toNum(document.getElementById('out_M').value);
            const gamma = toNum(document.getElementById('out_gamma').value);
            const LFL = getLFL('out_LFL');
            const T = toNum(document.getElementById('out_T').value);
            
            // Upstream parameters
            const S_mm2_upstream = toNum(document.getElementById('out_S_upstream').value);
            const Cd_upstream = toNum(document.getElementById('out_Cd_upstream').value);
            const P0_bar_upstream = toNum(document.getElementById('out_p_upstream').value);
            
            // Downstream parameters  
            const S_mm2_downstream = toNum(document.getElementById('out_S_downstream').value);
            const Cd_downstream = toNum(document.getElementById('out_Cd_downstream').value);
            const P0_bar_downstream = toNum(document.getElementById('out_p_downstream').value);
            
            const Pa = toNum(document.getElementById('out_Pa').value);
            const R = toNum(document.getElementById('out_R').value);
            const Z = toNum(document.getElementById('out_Z').value);
            
            // Validate inputs
            if (!M || !gamma || !LFL || !T || !S_mm2_upstream || !S_mm2_downstream || 
                !Cd_upstream || !Cd_downstream || !P0_bar_upstream || !P0_bar_downstream || !Pa || !R || !Z) {
                alert(currentLang === 'EN' 
                    ? 'Please fill all required fields in Outdoor Scenario.' 
                    : 'Будь ласка, заповніть всі обов\'язкові поля у сценарії на відкритому повітрі.');
                return;
            }
            
            // Convert units
            const S_upstream = S_mm2_upstream * 1e-6;
            const S_downstream = S_mm2_downstream * 1e-6;
            const P0_upstream = P0_bar_upstream * 1e5;
            const P0_downstream = P0_bar_downstream * 1e5;
            
            // Calculate gas density
            const rho_g = calculateGasDensity(Pa, M, R, T);
            
            // Calculate critical pressures - ИСПРАВЛЕННАЯ ФОРМУЛА
            const P_crit = calculateCriticalPressure(Pa, gamma);
            
            // Calculate mass release rates
            const mdot_upstream = calculateMassReleaseRate(Cd_upstream, S_upstream, P0_upstream, Pa, gamma, M, R, T, Z);
            const mdot_downstream = calculateMassReleaseRate(Cd_downstream, S_downstream, P0_downstream, Pa, gamma, M, R, T, Z);
            
            // Calculate volumetric release characteristics
            const Qc_upstream = calculateVolumetricReleaseCharacteristic(mdot_upstream, rho_g, LFL);
            const Qc_downstream = calculateVolumetricReleaseCharacteristic(mdot_downstream, rho_g, LFL);
            
            // Get release types
            const releaseType_upstream = document.getElementById('out_release_type_upstream').value;
            const releaseType_downstream = document.getElementById('out_release_type_downstream').value;
            const ventilationAvailability = 'Good';
            
            // Determine flow types
            const flowType_upstream = P0_upstream > P_crit ? 'Choked' : 'Subsonic';
            const flowType_downstream = P0_downstream > P_crit ? 'Choked' : 'Subsonic';
            
            // Display results
            const el = document.getElementById('resOutdoor');
            const L = currentLang === 'EN';
            
            el.innerHTML = `
                <div class="section-title">${L ? 'Detailed Calculation Results' : 'Детальні результати розрахунків'}</div>
                
                <div class="section-title">${L ? 'Critical Pressure Analysis' : 'Аналіз критичного тиску'}</div>
                <div class="calculation-steps">
                    <p><strong>${L ? 'Critical pressure formula (IEC 60079-10-1:2015):' : 'Формула критичного тиску (IEC 60079-10-1:2015):'}</strong></p>
                    <p class="formula">P<sub>crit</sub> = P<sub>a</sub> × [(γ+1)/2]<sup>γ/(γ-1)</sup></p>
                    
                    <p><strong>${L ? 'Calculation:' : 'Розрахунок:'}</strong></p>
                    <p class="formula">
                        P<sub>crit</sub> = ${fmt(Pa, 2)} × [(${gamma}+1)/2]<sup>${gamma}/(${gamma}-1)</sup><br>
                        = ${fmt(Pa, 2)} × [${(gamma+1).toFixed(2)}/2]<sup>${gamma}/${(gamma-1).toFixed(2)}</sup><br>
                        = ${fmt(Pa, 2)} × [${((gamma+1)/2).toFixed(5)}]<sup>${(gamma/(gamma-1)).toFixed(3)}</sup><br>
                        = ${fmt(Pa, 2)} × ${Math.pow((gamma+1)/2, gamma/(gamma-1)).toFixed(5)}<br>
                        = <strong>${fmt(P_crit, 2)} Pa (${fmt(P_crit/1e5, 3)} bar abs)</strong>
                    </p>
                </div>
                
                <div class="section-title">${L ? 'Gas Properties' : 'Властивості газу'}</div>
                <div class="row">
                    <span>${L ? 'Gas density ρ<sub>g</sub>' : 'Щільність газу ρ<sub>g</sub>'}</span>
                    <span class="val">${fmt(rho_g, 6)} kg/m³</span>
                </div>
                
                <div class="section-title">${L ? 'Upstream Release Calculations' : 'Розрахунки для викиду до регулятора'}</div>
                <div class="row">
                    <span>${L ? 'Upstream pressure P₀' : 'Тиск до регулятора P₀'}</span>
                    <span class="val">${fmt(P0_upstream, 6)} Pa (${fmt(P0_bar_upstream, 2)} bar abs)</span>
                </div>
                <div class="row">
                    <span>${L ? 'Critical pressure P<sub>crit</sub>' : 'Критичний тиск P<sub>crit</sub>'}</span>
                    <span class="val">${fmt(P_crit, 6)} Pa (${fmt(P_crit / 1e5, 3)} bar abs)</span>
                </div>
                <div class="row">
                    <span>${L ? 'Atmospheric pressure P<sub>a</sub>' : 'Атмосферний тиск P<sub>a</sub>'}</span>
                    <span class="val">${fmt(Pa, 6)} Pa (${fmt(Pa / 1e5, 2)} bar abs)</span>
                </div>
                <div class="flow-info ${flowType_upstream.toLowerCase()}">
                    <div class="row">
                        <span>${L ? 'Flow type' : 'Тип потоку'}</span>
                        <span class="val">${flowType_upstream}</span>
                    </div>
                    <div class="row">
                        <span>${L ? 'Flow condition' : 'Умова потоку'}</span>
                        <span class="val">${flowType_upstream === 'Choked' ? 
                            (L ? 'P₀ > P<sub>crit</sub> (sonic flow at orifice)' : 'P₀ > P<sub>crit</sub> (звуковий потік у отворі)') : 
                            (L ? 'P₀ ≤ P<sub>crit</sub> (subsonic flow)' : 'P₀ ≤ P<sub>crit</sub> (дозвуковий потік)')}</span>
                    </div>
                </div>
                <div class="row">
                    <span>${L ? 'Hole area S' : 'Площа отвору S'}</span>
                    <span class="val">${fmt(S_upstream, 10)} m²</span>
                </div>
                <div class="row">
                    <span>${L ? 'Mass flow rate ṁ' : 'Масова витрата ṁ'}</span>
                    <span class="val">${fmt(mdot_upstream, 10)} kg/s</span>
                </div>
                <div class="row">
                    <span>Q<sub>c</sub> (release characteristic)</span>
                    <span class="val">${fmt(Qc_upstream, 10)} m³/s</span>
                </div>
                
                <div class="section-title">${L ? 'Downstream Release Calculations' : 'Розрахунки для викиду після регулятора'}</div>
                <div class="row">
                    <span>${L ? 'Downstream pressure P₀' : 'Тиск після регулятора P₀'}</span>
                    <span class="val">${fmt(P0_downstream, 6)} Pa (${fmt(P0_bar_downstream, 2)} bar abs)</span>
                </div>
                <div class="row">
                    <span>${L ? 'Critical pressure P<sub>crit</sub>' : 'Критичний тиск P<sub>crit</sub>'}</span>
                    <span class="val">${fmt(P_crit, 6)} Pa (${fmt(P_crit / 1e5, 3)} bar abs)</span>
                </div>
                <div class="row">
                    <span>${L ? 'Atmospheric pressure P<sub>a</sub>' : 'Атмосферний тиск P<sub>a</sub>'}</span>
                    <span class="val">${fmt(Pa, 6)} Pa (${fmt(Pa / 1e5, 2)} bar abs)</span>
                </div>
                <div class="flow-info ${flowType_downstream.toLowerCase()}">
                    <div class="row">
                        <span>${L ? 'Flow type' : 'Тип потоку'}</span>
                        <span class="val">${flowType_downstream}</span>
                    </div>
                    <div class="row">
                        <span>${L ? 'Flow condition' : 'Умова потоку'}</span>
                        <span class="val">${flowType_downstream === 'Choked' ? 
                            (L ? 'P₀ > P<sub>crit</sub> (sonic flow at orifice)' : 'P₀ > P<sub>crit</sub> (звуковий потік у отворі)') : 
                            (L ? 'P₀ ≤ P<sub>crit</sub> (subsonic flow)' : 'P₀ ≤ P<sub>crit</sub> (дозвуковий потік)')}</span>
                    </div>
                </div>
                <div class="row">
                    <span>${L ? 'Hole area S' : 'Площа отвору S'}</span>
                    <span class="val">${fmt(S_downstream, 10)} m²</span>
                </div>
                <div class="row">
                    <span>${L ? 'Mass flow rate ṁ' : 'Масова витрата ṁ'}</span>
                    <span class="val">${fmt(mdot_downstream, 10)} kg/s</span>
                </div>
                <div class="row">
                    <span>Q<sub>c</sub> (release characteristic)</span>
                    <span class="val">${fmt(Qc_downstream, 10)} m³/s</span>
                </div>
                
                <div class="final-classification">
                    <div class="section-title">${L ? 'Final Zone Classification' : 'Фінальна класифікація зон'}</div>
                    <p class="hint">${L ? 'Based on the calculated Qc values, determine dilution level from Figure C.1 and zone extent from Figure D.1 of the standard, then enter below:' : 'На основі розрахованих значень Qc визначте рівень розведення з Рисунку C.1 та протяжність зони з Рисунку D.1 стандарту, потім введіть нижче:'}</p>
                    
                    <div class="grid">
                        <div>
                            <div class="section-title">${L ? 'Upstream Classification' : 'Класифікація до регулятора'}</div>
                            <div class="input">
                                <label>${L ? 'Dilution Level' : 'Рівень розведення'}</label>
                                <select id="out_final_dilution_upstream">
                                    <option value="High">High</option>
                                    <option value="Medium" selected>Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                            <div class="input">
                                <label>${L ? 'Zone Extent (m)' : 'Протяжність зони (м)'}</label>
                                <input type="number" step="any" id="out_final_extent_upstream" value="1.0">
                            </div>
                            <div class="row">
                                <span>${L ? 'Upstream Zone Type' : 'Тип зони до регулятора'}</span>
                                <span class="val" id="out_final_zone_upstream">---</span>
                            </div>
                        </div>
                        <div>
                            <div class="section-title">${L ? 'Downstream Classification' : 'Класифікація після регулятора'}</div>
                            <div class="input">
                                <label>${L ? 'Dilution Level' : 'Рівень розведення'}</label>
                                <select id="out_final_dilution_downstream">
                                    <option value="High">High</option>
                                    <option value="Medium" selected>Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                            <div class="input">
                                <label>${L ? 'Zone Extent (m)' : 'Протяжність зони (м)'}</label>
                                <input type="number" step="any" id="out_final_extent_downstream" value="1.0">
                            </div>
                            <div class="row">
                                <span>${L ? 'Downstream Zone Type' : 'Тип зони після регулятора'}</span>
                                <span class="val" id="out_final_zone_downstream">---</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Function to update final classification
            function updateFinalClassification() {
                const dilution_upstream = document.getElementById('out_final_dilution_upstream').value;
                const dilution_downstream = document.getElementById('out_final_dilution_downstream').value;
                const extent_upstream = toNum(document.getElementById('out_final_extent_upstream').value);
                const extent_downstream = toNum(document.getElementById('out_final_extent_downstream').value);

                const zoneType_upstream = determineZoneType(releaseType_upstream, ventilationAvailability, dilution_upstream);
                const zoneType_downstream = determineZoneType(releaseType_downstream, ventilationAvailability, dilution_downstream);

                document.getElementById('out_final_zone_upstream').textContent = `${zoneType_upstream} (${fmt(extent_upstream, 2)} m)`;
                document.getElementById('out_final_zone_downstream').textContent = `${zoneType_downstream} (${fmt(extent_downstream, 2)} m)`;
            }

            // Initialize and add event listeners
            updateFinalClassification();
            document.getElementById('out_final_dilution_upstream').addEventListener('change', updateFinalClassification);
            document.getElementById('out_final_dilution_downstream').addEventListener('change', updateFinalClassification);
            document.getElementById('out_final_extent_upstream').addEventListener('input', updateFinalClassification);
            document.getElementById('out_final_extent_downstream').addEventListener('input', updateFinalClassification);
        });

        // CORRECTED Enclosed Scenario calculation
        document.getElementById('btnEnclosed').addEventListener('click', function() {
            // Get input values
            const M = toNum(document.getElementById('enc_M').value);
            const gamma = toNum(document.getElementById('enc_gamma').value);
            const LFL = getLFL('enc_LFL');
            const T = toNum(document.getElementById('enc_T').value);
            
            // Release parameters
            const S_mm2 = toNum(document.getElementById('enc_S').value);
            const Cd = toNum(document.getElementById('enc_Cd').value);
            const P0_bar = toNum(document.getElementById('enc_p').value);
            
            const Pa = toNum(document.getElementById('enc_Pa').value);
            const R = toNum(document.getElementById('enc_R').value);
            const Z = toNum(document.getElementById('enc_Z').value);
            
            // Room parameters
            const L = toNum(document.getElementById('enc_length').value);
            const W = toNum(document.getElementById('enc_width').value);
            const H = toNum(document.getElementById('enc_height').value);
            
            // Ventilation parameters
            const A1 = toNum(document.getElementById('enc_A1').value);
            const A2 = toNum(document.getElementById('enc_A2').value);
            const Cd_vent = toNum(document.getElementById('enc_Cd_vent').value);
            const deltaCp = toNum(document.getElementById('enc_deltaCp').value);
            const windSpeed = toNum(document.getElementById('enc_wind_speed').value);
            const f = toNum(document.getElementById('enc_f').value);
            
            const releaseType = document.getElementById('enc_release_type').value;
            
            // Validate inputs
            if (!M || !gamma || !LFL || !T || !S_mm2 || !Cd || !P0_bar || !Pa || !R || !Z || 
                !L || !W || !H || !A1 || !A2 || !Cd_vent || !deltaCp || !windSpeed || !f) {
                alert(currentLang === 'EN' 
                    ? 'Please fill all required fields in Enclosed Scenario.' 
                    : 'Будь ласка, заповніть всі обов\'язкові поля у сценарії у приміщенні.');
                return;
            }
            
            // Convert units
            const S = S_mm2 * 1e-6;
            const P0 = P0_bar * 1e5;
            
            // Calculate room volume
            const V0 = L * W * H;
            document.getElementById('enc_volume').value = fmt(V0, 2);
            
            // Calculate gas density
            const rho_g = calculateGasDensity(Pa, M, R, T);
            
            // Calculate critical pressure
            const P_crit = calculateCriticalPressure(Pa, gamma);
            
            // Calculate mass release rate
            const mdot = calculateMassReleaseRate(Cd, S, P0, Pa, gamma, M, R, T, Z);
            
            // Calculate volumetric flows
            const Qg = mdot / rho_g;
            const Qc = calculateVolumetricReleaseCharacteristic(mdot, rho_g, LFL);
            
            // Calculate ventilation parameters - ИСПРАВЛЕННЫЕ ФОРМУЛЫ
            const Ae = calculateEffectiveVentilationArea(A1, A2);
            const Qa = calculateAirFlowRate(Cd_vent, Ae, windSpeed, deltaCp);
            const uw = calculateVentilationVelocity(Qa, L, H);
            const Q2 = Qa + Qg;
            const Xb = calculateBackgroundConcentration(f, Qg, Q2);
            const C = calculateAirChangeRate(Qa, V0);
            
            // Determine flow type
            const flowType = P0 > P_crit ? 'Choked' : 'Subsonic';
            
            // Determine dilution level based on background concentration
            const Xcrit = 0.25 * LFL;
            const dilutionLevel = Xb <= Xcrit ? 'Medium' : 'Low';
            
            // Determine ventilation availability (typically 'Fair' for enclosed spaces)
            const ventilationAvailability = 'Fair';
            
            // Display results
            const el = document.getElementById('resEnclosed');
            const L_lang = currentLang === 'EN';
            
            el.innerHTML = `
                <div class="section-title">${L_lang ? 'Detailed Calculation Results' : 'Детальні результати розрахунків'}</div>
                
                <div class="section-title">${L_lang ? 'Critical Pressure Analysis' : 'Аналіз критичного тиску'}</div>
                <div class="calculation-steps">
                    <p><strong>${L_lang ? 'Critical pressure formula (IEC 60079-10-1:2015):' : 'Формула критичного тиску (IEC 60079-10-1:2015):'}</strong></p>
                    <p class="formula">P<sub>crit</sub> = P<sub>a</sub> × [(γ+1)/2]<sup>γ/(γ-1)</sup></p>
                    
                    <p><strong>${L_lang ? 'Calculation:' : 'Розрахунок:'}</strong></p>
                    <p class="formula">
                        P<sub>crit</sub> = ${fmt(Pa, 2)} × [(${gamma}+1)/2]<sup>${gamma}/(${gamma}-1)</sup> = <strong>${fmt(P_crit, 2)} Pa (${fmt(P_crit/1e5, 3)} bar abs)</strong>
                    </p>
                </div>
                
                <div class="section-title">${L_lang ? 'Gas Properties' : 'Властивості газу'}</div>
                <div class="row">
                    <span>${L_lang ? 'Gas density ρ<sub>g</sub>' : 'Щільність газу ρ<sub>g</sub>'}</span>
                    <span class="val">${fmt(rho_g, 6)} kg/m³</span>
                </div>
                
                <div class="section-title">${L_lang ? 'Release Calculations' : 'Розрахунки викиду'}</div>
                <div class="row">
                    <span>${L_lang ? 'Upstream pressure P₀' : 'Тиск P₀'}</span>
                    <span class="val">${fmt(P0, 6)} Pa (${fmt(P0_bar, 2)} bar abs)</span>
                </div>
                <div class="flow-info ${flowType.toLowerCase()}">
                    <div class="row">
                        <span>${L_lang ? 'Flow type' : 'Тип потоку'}</span>
                        <span class="val">${flowType}</span>
                    </div>
                </div>
                <div class="row">
                    <span>${L_lang ? 'Mass flow rate ṁ' : 'Масова витрата ṁ'}</span>
                    <span class="val">${fmt(mdot, 10)} kg/s</span>
                </div>
                <div class="row">
                    <span>Q<sub>g</sub> (gas volumetric flow)</span>
                    <span class="val">${fmt(Qg, 10)} m³/s</span>
                </div>
                <div class="row">
                    <span>Q<sub>c</sub> (release characteristic)</span>
                    <span class="val">${fmt(Qc, 10)} m³/s</span>
                </div>
                
                <div class="section-title">${L_lang ? 'Ventilation Analysis' : 'Аналіз вентиляції'}</div>
                <div class="calculation-steps">
                    <p><strong>${L_lang ? 'Air flow rate calculation:' : 'Розрахунок витрати повітря:'}</strong></p>
                    <p class="formula">Q<sub>a</sub> = C<sub>d</sub> × A<sub>e</sub> × u<sub>w</sub> × √ΔC<sub>p</sub></p>
                    <p class="formula">
                        Q<sub>a</sub> = ${fmt(Cd_vent, 3)} × ${fmt(Ae, 6)} × ${fmt(windSpeed, 3)} × √${fmt(deltaCp, 3)}<br>
                        = ${fmt(Cd_vent, 3)} × ${fmt(Ae, 6)} × ${fmt(windSpeed, 3)} × ${fmt(Math.sqrt(deltaCp), 3)}<br>
                        = <strong>${fmt(Qa, 6)} m³/s</strong>
                    </p>
                </div>
                <div class="row">
                    <span>${L_lang ? 'Effective ventilation area A<sub>e</sub>' : 'Ефективна площа вентиляції A<sub>e</sub>'}</span>
                    <span class="val">${fmt(Ae, 6)} m²</span>
                </div>
                <div class="row">
                    <span>${L_lang ? 'Wind speed u<sub>w</sub>' : 'Швидкість вітру u<sub>w</sub>'}</span>
                    <span class="val">${fmt(windSpeed, 3)} m/s</span>
                </div>
                <div class="row">
                    <span>${L_lang ? 'Air flow rate Q<sub>a</sub>' : "Витрата повітря Q<sub>a</sub>"}</span>
                    <span class="val">${fmt(Qa, 6)} m³/s</span>
                </div>
                
                <div class="calculation-steps">
                    <p><strong>${L_lang ? 'Ventilation velocity calculation:' : 'Розрахунок швидкості вентиляції:'}</strong></p>
                    <p class="formula">u<sub>w</sub>(indoor) = Q<sub>a</sub> / (L × H)</p>
                    <p class="formula">
                        u<sub>w</sub> = ${fmt(Qa, 6)} / (${fmt(L, 2)} × ${fmt(H, 2)})<br>
                        = ${fmt(Qa, 6)} / ${fmt(L * H, 3)}<br>
                        = <strong>${fmt(uw, 6)} m/s</strong>
                    </p>
                </div>
                <div class="row">
                    <span>${L_lang ? 'Ventilation velocity u<sub>w</sub>' : 'Швидкість вентиляції u<sub>w</sub>'}</span>
                    <span class="val">${fmt(uw, 6)} m/s</span>
                </div>
                
                <div class="calculation-steps">
                    <p><strong>${L_lang ? 'Air change rate calculation:' : 'Розрахунок частоти повітрообміну:'}</strong></p>
                    <p class="formula">C = Q<sub>a</sub> / V<sub>0</sub></p>
                    <p class="formula">
                        C = ${fmt(Qa, 6)} / ${fmt(V0, 3)}<br>
                        = <strong>${fmt(C, 6)} s⁻¹ (${fmt(C * 3600, 2)} h⁻¹)</strong>
                    </p>
                </div>
                <div class="row">
                    <span>${L_lang ? 'Air change rate C' : 'Частота повітрообміну C'}</span>
                    <span class="val">${fmt(C, 6)} s⁻¹ (${fmt(C * 3600, 2)} h⁻¹)</span>
                </div>
                
                <div class="row">
                    <span>${L_lang ? 'Background concentration X<sub>b</sub>' : 'Фонова концентрація X<sub>b</sub>'}</span>
                    <span class="val">${fmt(Xb, 6)} vol/vol</span>
                </div>
                <div class="row">
                    <span>${L_lang ? 'Critical concentration X<sub>crit</sub>' : 'Критична концентрація X<sub>crit</sub>'}</span>
                    <span class="val">${fmt(Xcrit, 6)} vol/vol</span>
                </div>
                <div class="row">
                    <span>${L_lang ? 'Dilution level' : 'Рівень розведення'}</span>
                    <span class="val">${dilutionLevel} ${Xb > Xcrit ? '⚠️' : '✓'}</span>
                </div>
                
                <div class="final-classification">
                    <div class="section-title">${L_lang ? 'Final Zone Classification' : 'Фінальна класифікація зон'}</div>
                    
                    <div class="grid">
                        <div>
                            <div class="input">
                                <label>${L_lang ? 'Ventilation Availability' : 'Доступність вентиляції'}</label>
                                <select id="enc_final_ventilation">
                                    <option value="Good">Good</option>
                                    <option value="Fair" selected>Fair</option>
                                    <option value="Poor">Poor</option>
                                </select>
                            </div>
                            <div class="input">
                                <label>${L_lang ? 'Zone Extent (m)' : 'Протяжність зони (м)'}</label>
                                <input type="number" step="any" id="enc_final_extent" value="1.0">
                            </div>
                            <div class="row">
                                <span>${L_lang ? 'Zone Type' : 'Тип зони'}</span>
                                <span class="val" id="enc_final_zone">---</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Function to update final classification for enclosed scenario
            function updateEnclosedClassification() {
                const ventilation = document.getElementById('enc_final_ventilation').value;
                const extent = toNum(document.getElementById('enc_final_extent').value);

                const zoneType = determineZoneType(releaseType, ventilation, dilutionLevel);

                document.getElementById('enc_final_zone').textContent = `${zoneType} (${fmt(extent, 2)} m)`;
            }

            // Initialize and add event listeners
            updateEnclosedClassification();
            document.getElementById('enc_final_ventilation').addEventListener('change', updateEnclosedClassification);
            document.getElementById('enc_final_extent').addEventListener('input', updateEnclosedClassification);
        });

        // Auto-calculate room volume when dimensions change
        document.getElementById('enc_length').addEventListener('input', updateRoomVolume);
        document.getElementById('enc_width').addEventListener('input', updateRoomVolume);
        document.getElementById('enc_height').addEventListener('input', updateRoomVolume);

        function updateRoomVolume() {
            const L = toNum(document.getElementById('enc_length').value) || 0;
            const W = toNum(document.getElementById('enc_width').value) || 0;
            const H = toNum(document.getElementById('enc_height').value) || 0;
            const V0 = L * W * H;
            document.getElementById('enc_volume').value = fmt(V0, 2);
        }

        // Initialize
        setLang('EN');
    </script>
</body>
</html>
